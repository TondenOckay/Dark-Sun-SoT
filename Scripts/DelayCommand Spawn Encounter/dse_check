// ============================================================================
// dse_check
// ============================================================================
// DELAYED SCRIPT: Executes every 2 minutes per player
// This is the main "heartbeat" of the encounter system
// 
// Purpose:
// - Checks if this player should run an encounter (lowest ID in proximity)
// - Verifies no active encounters are already running
// - Rolls for encounter chance (20%)
// - Spawns creatures if the roll succeeds
// - Schedules itself to run again in 2 minutes
// 
// How it works:
// This script is first called by encounter_onenter, then repeatedly
// calls itself using DelayCommand, creating a continuous cycle
// ============================================================================

#include "dse_inc"

// Forward declarations - these functions are defined later in this file
void SpawnEncounter(object oPlayer);
void CheckDespawn(object oCreature);

void main()
{
    // OBJECT_SELF is the player this script is running for
    // (set when ExecuteScript was called with the player as second parameter)
    object oPC = OBJECT_SELF;
    
    // ========================================================================
    // VALIDATION CHECK
    // ========================================================================
    // Make sure the player object is still valid and is actually a PC
    // They might have logged out or the object could be invalid
    // ========================================================================
    if (!GetIsObjectValid(oPC) || !GetIsPC(oPC))
        return;  // Exit the script, don't reschedule
    
    // ========================================================================
    // PROXIMITY CHECK - DETERMINE IF THIS PLAYER SHOULD RUN THE ENCOUNTER
    // ========================================================================
    // When multiple players are near each other, only the one with the
    // lowest ID should run encounters. This prevents duplicate spawns.
    // ========================================================================
    
    // Find the player with the lowest ID within 20 meters
    object oLowestPC = GetLowestIDPlayerInProximity(oPC);
    
    // Check if this player is NOT the lowest ID player
    if (oLowestPC != oPC)
    {
        // This player should pause their encounter checks
        // Schedule another check in 2 minutes and exit
        DelayCommand(ENCOUNTER_CHECK_INTERVAL, ExecuteScript("encounter_check", oPC));
        return;
    }
    
    // ========================================================================
    // ACTIVE ENCOUNTER CHECK
    // ========================================================================
    // If this player already has spawned creatures that are still alive,
    // don't spawn more. Wait for them to be defeated or despawn.
    // ========================================================================
    if (HasActiveEncounterSpawns(oPC))
    {
        // Active encounter in progress, check again later
        DelayCommand(ENCOUNTER_CHECK_INTERVAL, ExecuteScript("encounter_check", oPC));
        return;
    }
    
    // ========================================================================
    // ENCOUNTER ROLL
    // ========================================================================
    // Roll d100 (1-100) to see if an encounter should occur
    // There's a 20% chance (1-20 on d100) for success
    // ========================================================================
    int nEncounterRoll = d100();
    
    if (nEncounterRoll <= ENCOUNTER_CHANCE)
    {
        // Success! The 20% chance triggered
        // Spawn creatures for this player
        SpawnEncounter(oPC);
    }
    
    // ========================================================================
    // SCHEDULE NEXT CHECK
    // ========================================================================
    // Regardless of whether an encounter spawned, schedule the next check
    // This creates the continuous 2-minute cycle
    // ========================================================================
    DelayCommand(ENCOUNTER_CHECK_INTERVAL, ExecuteScript("encounter_check", oPC));
}

// ============================================================================
// SPAWN ENCOUNTER
// ============================================================================
// Creates an encounter for the specified player
// 
// Process:
// 1. Determine rarity (Common 70%, Uncommon 25%, Rare 5%)
// 2. Roll on the appropriate encounter table to select a creature
// 3. Determine number of creatures to spawn (1-6)
// 4. Determine spawn distance (5m, 10-20m, or 30m)
// 5. Spawn creatures in a circle around the player
// 6. Set up each creature with proper variables and despawn timers
// 7. Mark the encounter as active for this player
// 
// Parameters:
//   oPlayer - The player to spawn an encounter for
// ============================================================================
void SpawnEncounter(object oPlayer)
{
    // ========================================================================
    // STEP 1: DETERMINE ENCOUNTER RARITY
    // ========================================================================
    // Roll d100 to determine which encounter table to use
    //   1-70: Common encounter (70% chance)
    //  71-95: Uncommon encounter (25% chance)
    // 96-100: Rare encounter (5% chance)
    // ========================================================================
    int nRarityRoll = d100();
    string sCreatureResRef;  // Will hold the blueprint ResRef of the creature
    
    if (nRarityRoll <= 70) {
        // Common encounter - get a creature from the common table
        struct EncounterEntry entry = GetCommonEncounter(d100());
        sCreatureResRef = entry.sResRef;
    } else if (nRarityRoll <= 95) {
        // Uncommon encounter - get a creature from the uncommon table
        struct EncounterEntry entry = GetUncommonEncounter(d100());
        sCreatureResRef = entry.sResRef;
    } else {
        // Rare encounter - get a creature from the rare table
        struct EncounterEntry entry = GetRareEncounter(d100());
        sCreatureResRef = entry.sResRef;
    }
    
    // ========================================================================
    // STEP 2: DETERMINE CREATURE COUNT
    // ========================================================================
    // Random(6) gives 0-5, add 1 to get 1-6 creatures
    // ========================================================================
    int nCount = Random(6) + 1;
    
    // ========================================================================
    // STEP 3: DETERMINE SPAWN DISTANCE
    // ========================================================================
    // Get the distance based on weighted probabilities (5m, 10-20m, or 30m)
    // ========================================================================
    float fDistance = GetSpawnDistance();
    
    // ========================================================================
    // STEP 4: GET PLAYER POSITION
    // ========================================================================
    // We need the player's location and position vector for calculations
    // ========================================================================
    location lPlayer = GetLocation(oPlayer);
    vector vPlayer = GetPositionFromLocation(lPlayer);
    
    // ========================================================================
    // STEP 5: SPAWN CREATURES IN A CIRCLE
    // ========================================================================
    // Loop to create each creature at random positions around the player
    // ========================================================================
    int i;
    for (i = 0; i < nCount; i++)
    {
        // --------------------------------------------------------------------
        // Calculate random spawn position
        // --------------------------------------------------------------------
        // Pick a random angle (0-360 degrees) around the player
        float fAngle = IntToFloat(Random(360));
        
        // Convert degrees to radians for trigonometric functions
        // Radians = Degrees × π / 180
        float fRadians = fAngle * 3.14159 / 180.0;
        
        // Calculate spawn position using polar coordinates
        // x = player_x + (distance × cosine of angle)
        // y = player_y + (distance × sine of angle)
        // This creates a circle of spawn points around the player
        vector vSpawn;
        vSpawn.x = vPlayer.x + (fDistance * cos(fRadians));
        vSpawn.y = vPlayer.y + (fDistance * sin(fRadians));
        vSpawn.z = vPlayer.z;  // Same height as player
        
        // Create a location object from the calculated position
        location lSpawn = Location(GetAreaFromLocation(lPlayer), vSpawn, fAngle);
        
        // --------------------------------------------------------------------
        // Create the creature
        // --------------------------------------------------------------------
        // CreateObject parameters:
        //   OBJECT_TYPE_CREATURE - type of object to create
        //   sCreatureResRef - blueprint to use
        //   lSpawn - where to create it
        //   FALSE - don't use appearance type
        //   ENCOUNTER_SPAWN_TAG - tag for the creature
        object oCreature = CreateObject(OBJECT_TYPE_CREATURE, sCreatureResRef, lSpawn, FALSE, ENCOUNTER_SPAWN_TAG);
        
        // Verify the creature was successfully created
        if (GetIsObjectValid(oCreature))
        {
            // ----------------------------------------------------------------
            // Set up creature variables
            // ----------------------------------------------------------------
            
            // Store reference to which player this creature was spawned for
            SetLocalObject(oCreature, "SPAWNED_FOR_PLAYER", oPlayer);
            
            // Store reference on the player to track this creature
            // Each creature gets a unique index (0, 1, 2, etc.)
            SetLocalObject(oPlayer, "ENCOUNTER_CREATURE_" + IntToString(i), oCreature);
            
            // Record the current time as the last interaction
            // This starts the 4-minute despawn timer
            UpdateCreatureInteraction(oCreature);
            
            // ----------------------------------------------------------------
            // Make creature hostile
            // ----------------------------------------------------------------
            // Change the creature's faction to hostile so it attacks the player
            ChangeToStandardFaction(oCreature, STANDARD_FACTION_HOSTILE);
            
            // ----------------------------------------------------------------
            // Start despawn check cycle
            // ----------------------------------------------------------------
            // Schedule the first despawn check in 10 seconds
            // This will then check every 10 seconds if the creature should despawn
            DelayCommand(10.0, CheckDespawn(oCreature));
        }
    }
    
    // ========================================================================
    // MARK ENCOUNTER AS ACTIVE
    // ========================================================================
    // Set variables on the player to track this active encounter
    // ========================================================================
    SetEncounterActive(oPlayer, TRUE);
    SetLocalInt(oPlayer, "ENCOUNTER_CREATURE_COUNT", nCount);
}

// ============================================================================
// CHECK DESPAWN
// ============================================================================
// Monitors a spawned creature to determine if it should despawn
// This function calls itself every 10 seconds to continuously monitor
// 
// Despawn conditions:
// - 4 minutes have passed with no interaction (not in combat)
// - The creature is killed
// 
// Also handles:
// - Clearing the encounter active status when all creatures are gone
// - Updating interaction time when creature enters combat
// 
// Parameters:
//   oCreature - The creature to monitor
// ============================================================================
void CheckDespawn(object oCreature)
{
    // ========================================================================
    // CHECK IF CREATURE IS ALREADY GONE
    // ========================================================================
    // If the creature is invalid or dead, check if all encounter creatures
    // are defeated so we can clear the encounter active status
    // ========================================================================
    if (!GetIsObjectValid(oCreature) || GetIsDead(oCreature))
    {
        // Get the player this creature was spawned for
        object oPlayer = GetLocalObject(oCreature, "SPAWNED_FOR_PLAYER");
        
        if (GetIsObjectValid(oPlayer))
        {
            // Get the total number of creatures that were spawned
            int nCount = GetLocalInt(oPlayer, "ENCOUNTER_CREATURE_COUNT");
            int nDeadCount = 0;
            
            // Loop through all creatures and count how many are dead/gone
            int i;
            for (i = 0; i < nCount; i++)
            {
                object oCheck = GetLocalObject(oPlayer, "ENCOUNTER_CREATURE_" + IntToString(i));
                if (!GetIsObjectValid(oCheck) || GetIsDead(oCheck))
                {
                    nDeadCount++;
                }
            }
            
            // If all creatures are dead/gone, clear the active encounter status
            if (nDeadCount >= nCount)
            {
                SetEncounterActive(oPlayer, FALSE);
            }
        }
        
        // Exit the function - don't reschedule since creature is gone
        return;
    }
    
    // ========================================================================
    // CHECK FOR ACTIVE COMBAT
    // ========================================================================
    // If the creature is in combat, update interaction time and keep checking
    // This prevents creatures from despawning during active fights
    // ========================================================================
    
    // Get the player this creature was spawned for (needed for later checks)
    object oPlayer = GetLocalObject(oCreature, "SPAWNED_FOR_PLAYER");
    
    if (GetIsInCombat(oCreature))
    {
        // Creature is fighting - update interaction time to reset the timer
        UpdateCreatureInteraction(oCreature);
        
        // Schedule another check in 10 seconds
        DelayCommand(10.0, CheckDespawn(oCreature));
        return;
    }
    
    // ========================================================================
    // CHECK INACTIVITY TIMER
    // ========================================================================
    // If 4 minutes have passed with no interaction, despawn the creature
    // ========================================================================
    
    // Get the timestamp of the last interaction
    int nLastInteraction = GetLocalInt(oCreature, VAR_LAST_INTERACTION);
    
    // Get the current game time (in seconds)
    int nCurrentTime = FloatToInt(HoursToSeconds(GetTimeHour()));
    
    // Calculate how much time has passed since last interaction
    if ((nCurrentTime - nLastInteraction) >= FloatToInt(DESPAWN_TIME))
    {
        // 4 minutes have passed - time to despawn
        // DestroyObject with 1.0 second delay for smoother removal
        DestroyObject(oCreature, 1.0);
        
        // --------------------------------------------------------------------
        // Check if all creatures are now gone
        // --------------------------------------------------------------------
        if (GetIsObjectValid(oPlayer))
        {
            int nCount = GetLocalInt(oPlayer, "ENCOUNTER_CREATURE_COUNT");
            int nGoneCount = 0;
            
            // Count how many creatures are gone (including this one about to despawn)
            int i;
            for (i = 0; i < nCount; i++)
            {
                object oCheck = GetLocalObject(oPlayer, "ENCOUNTER_CREATURE_" + IntToString(i));
                if (!GetIsObjectValid(oCheck) || GetIsDead(oCheck))
                {
                    nGoneCount++;
                }
            }
            
            // If all creatures except this one are gone (we're about to destroy this one)
            // Clear the active encounter status
            if (nGoneCount >= nCount - 1)
            {
                SetEncounterActive(oPlayer, FALSE);
            }
        }
    }
    else
    {
        // Not time to despawn yet - schedule another check in 10 seconds
        DelayCommand(10.0, CheckDespawn(oCreature));
    }
}
