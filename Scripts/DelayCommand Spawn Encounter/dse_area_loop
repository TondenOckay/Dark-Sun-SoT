// ============================================================================
// DSE: THE BRAIN (dse_area_loop)
// ============================================================================
// ============================================================================
// DSE_AREA_LOOP: THE MANAGER
// This script runs on a timer. It cleans up, checks players, and spawns mobs.
// ============================================================================
// ============================================================================
// DSE_AREA_LOOP: THE MASTER MANAGER
// This script handles: 1. Cleanup, 2. Player Tracking, 3. Radar, 4. Purging
// ============================================================================
#include "dse_inc"

void main() {
    object oArea = OBJECT_SELF; // The map this script is running in.

    // ------------------------------------------------------------------------
    // PHASE 1: GLOBAL CLEANUP
    // First, we delete any dead bodies left on the floor to keep it tidy.
    // ------------------------------------------------------------------------
    object oTrash = GetFirstObjectInArea(oArea);
    while (GetIsObjectValid(oTrash)) {
        if (GetTag(oTrash) == ENCOUNTER_TAG && GetIsDead(oTrash)) {
            SetLootable(oTrash, FALSE);
            AssignCommand(oTrash, SetIsDestroyable(TRUE, FALSE, FALSE));
            DestroyObject(oTrash, 0.1f);
        }
        oTrash = GetNextObjectInArea(oArea);
    }

    // ------------------------------------------------------------------------
    // PHASE 2: PLAYER LIST MANAGEMENT
    // We check our list of players (Bob, Bill, etc.) to see who is still here.
    // ------------------------------------------------------------------------
    int nCount = GetLocalInt(oArea, "AREA_PC_COUNT");
    int i;
    for (i = nCount; i >= 1; i--) {
        string sVar = "PLAYER_SLOT_" + IntToString(i);
        object oPC = GetLocalObject(oArea, sVar);

        if (!GetIsObjectValid(oPC) || GetArea(oPC) != oArea || GetIsDead(oPC)) {
            object oLast = GetLocalObject(oArea, "PLAYER_SLOT_" + IntToString(nCount));
            SetLocalObject(oArea, sVar, oLast);
            DeleteLocalObject(oArea, "PLAYER_SLOT_" + IntToString(nCount));
            nCount--;
        }
    }
    SetLocalInt(oArea, "AREA_PC_COUNT", nCount);

    // If the room is empty, stop the script to save server energy.
    if (nCount <= 0) {
        SetLocalInt(oArea, "DSE_LOOP_RUNNING", 0);
        return;
    }

    // ------------------------------------------------------------------------
    // PHASE 3: THE RADAR & SELECTIVE PURGE
    // We check each player to see if they outran their specific monsters.
    // ------------------------------------------------------------------------
    for (i = 1; i <= nCount; i++) {
        object oPC = GetLocalObject(oArea, "PLAYER_SLOT_" + IntToString(i));
        string sOwnerName = GetName(oPC);

        // Find the nearest monster.
        object oMob = GetNearestObjectByTag(ENCOUNTER_TAG, oPC);
        float fDist = GetDistanceBetween(oPC, oMob);
        string sMobOwner = GetLocalString(oMob, "MOB_OWNER");

        // LOGIC: Is the monster GONE, or DEAD, or NOT MINE, or TOO FAR (40m)?
        if (!GetIsObjectValid(oMob) || GetIsDead(oMob) || sMobOwner != sOwnerName || fDist > 40.0) {

            // STEP A: THE PURGE.
            // If we are here, it means the player is "Free." We must delete
            // any old monsters that might be lingering far away.
            object oPurge = GetFirstObjectInArea(oArea);
            while (GetIsObjectValid(oPurge)) {
                if (GetTag(oPurge) == ENCOUNTER_TAG && GetLocalString(oPurge, "MOB_OWNER") == sOwnerName) {
                    DestroyObject(oPurge); // Poof!
                }
                oPurge = GetNextObjectInArea(oArea);
            }

            // STEP B: THE NEW ROLL.
            // Now that the old mess is gone, we check if we should spawn new ones.
            if (d100() <= DSE_SPAWN_CHANCE) {
                ExecuteScript("dse_spawn_action", oPC);
            }
        }
        // If the monster WAS valid and WAS close, we do nothing and let the fight continue.
    }

    // Restart this script in 2 minutes (120 seconds).
    DelayCommand(120.0, ExecuteScript("dse_area_loop", oArea));
}
