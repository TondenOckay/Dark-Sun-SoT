// ============================================================================
// dse_ondeath
// ============================================================================
// MODULE EVENT: OnPlayerDeath
// This script fires whenever a player character dies
// 
// Purpose:
// - Immediately remove all encounter creatures when a player dies
// - Clears the active encounter status
// - Prevents dead players from having creatures following them around
// 
// How to use:
// Place this script in your module's OnPlayerDeath event
// It will work for all areas with the encounter system
// ============================================================================

#include "dse_inc"

void main()
{
    // ========================================================================
    // GET THE DEAD PLAYER
    // ========================================================================
    // GetLastPlayerDied() returns the player who just died
    // ========================================================================
    object oPC = GetLastPlayerDied();
    
    // Safety check: Verify this is actually a PC
    if (!GetIsPC(oPC)) return;
    
    // ========================================================================
    // CHECK FOR ACTIVE ENCOUNTER
    // ========================================================================
    // Only process if the player has active encounter creatures
    // ========================================================================
    if (HasActiveEncounterSpawns(oPC))
    {
        // Get how many creatures were spawned for this player
        int nCount = GetLocalInt(oPC, "ENCOUNTER_CREATURE_COUNT");
        
        // ====================================================================
        // DESTROY ALL ENCOUNTER CREATURES
        // ====================================================================
        // Loop through each creature and destroy it
        // ====================================================================
        int i;
        for (i = 0; i < nCount; i++)
        {
            // Get the creature object from the stored reference
            object oCreature = GetLocalObject(oPC, "ENCOUNTER_CREATURE_" + IntToString(i));
            
            // Verify the creature exists and isn't already dead
            if (GetIsObjectValid(oCreature) && !GetIsDead(oCreature))
            {
                // Destroy the creature with a 1 second delay for smooth removal
                DestroyObject(oCreature, 1.0);
            }
        }
        
        // ====================================================================
        // CLEAR ENCOUNTER STATUS
        // ====================================================================
        // Reset the player's encounter active status
        // This allows new encounters to spawn after they respawn
        // ====================================================================
        SetEncounterActive(oPC, FALSE);
    
